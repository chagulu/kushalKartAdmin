<!-- File: src/main/resources/templates/fragments/workerListing.html -->
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>KushalKart Admin - Worker Listing</title>
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport" />
  <link rel="icon" href="/admin-ui/img/kaiadmin/favicon.ico" type="image/x-icon" />

  <!-- Fonts and icons -->
  <script src="/admin-ui/js/plugin/webfont/webfont.min.js"></script>
  <script>
    WebFont.load({
      google: { families: ["Public Sans:300,400,500,600,700"] },
      custom: {
        families: ["Font Awesome 5 Solid","Font Awesome 5 Regular","Font Awesome 5 Brands","simple-line-icons"],
        urls: ["/admin-ui/css/fonts.min.css"],
      },
      active: function () {
        sessionStorage.fonts = true;
      },
    });
  </script>

  <!-- CSS Files -->
  <link rel="stylesheet" href="/admin-ui/css/bootstrap.min.css" />
  <link rel="stylesheet" href="/admin-ui/css/plugins.min.css" />
  <link rel="stylesheet" href="/admin-ui/css/kaiadmin.min.css" />
  <link rel="stylesheet" href="/admin-ui/css/demo.css" />

  <style>
    .actions-column {
      white-space: nowrap;
    }
    .actions-column button {
      margin-right: 5px;
    }
    /* KYC status badge colors */
    .status-btn {
      padding: 5px 10px;
      border: none;
      border-radius: 3px;
      color: white;
      font-weight: 600;
      font-size: 0.875rem;
      display: inline-block;
      min-width: 70px;
      text-align: center;
    }
    .status-pending {
      background-color: #f0ad4e;
    }
    .status-approved {
      background-color: #5cb85c;
    }
    .status-rejected {
      background-color: #d9534f;
    }
  </style>
</head>
<body>
<div class="wrapper">
  <div th:replace="fragments/sidebar :: sidebar"></div>
  <div class="main-panel">

    <div class="main-header">
      <div class="main-header-logo">
        <div class="logo-header" data-background-color="dark">
          <a href="/dashboard" class="logo">
            <img src="/admin-ui/img/kaiadmin/kushalkart.png" alt="Kushal Kart Logo" class="navbar-brand" height="20" />
          </a>
          <div class="nav-toggle">
            <button class="btn btn-toggle toggle-sidebar">
              <i class="gg-menu-right"></i>
            </button>
            <button class="btn btn-toggle sidenav-toggler">
              <i class="gg-menu-left"></i>
            </button>
          </div>
          <button class="topbar-toggler more">
            <i class="gg-more-vertical"></i>
          </button>
        </div>
      </div>
      <div th:replace="fragments/navbar :: navbar"></div>
    </div>

    <div class="container">
      <div class="page-inner">

        <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4">
          <div>
            <h3 class="fw-bold mb-3">Worker Listing</h3>
            <h6 class="op-7 mb-2">Manage Workers and Their KYC Status</h6>
          </div>
        </div>

        <!-- Register Worker Button aligned with Worker Listing title -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div></div>
          <div>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#registerWorkerModal" aria-label="Register Worker">
              + Register Worker
            </button>
          </div>
        </div>

<!-- Register Worker Modal -->
<div class="modal fade" id="registerWorkerModal" tabindex="-1" aria-labelledby="registerWorkerModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="registerWorkerForm">
        <input type="hidden" name="id" id="workerId" />
        <div class="modal-header">
          <h5 class="modal-title" id="registerWorkerModalLabel">Register New Worker</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body row g-3">
          <div class="col-md-6">
            <input type="text" class="form-control" name="name" id="workerName" placeholder="Full Name" required />
          </div>
          <div class="col-md-6">
            <input type="text" class="form-control" name="username" id="workerUsername" placeholder="Username" required />
          </div>
          <div class="col-md-6">
            <input type="email" class="form-control" name="email" id="workerEmail" placeholder="Email" required />
          </div>
          <div class="col-md-6">
            <input type="text" class="form-control" name="mobile" id="workerMobile" placeholder="Mobile Number" required />
          </div>
          <div class="col-md-6">
            <input type="password" class="form-control" name="password" id="workerPassword" placeholder="Password" />
          </div>
          <div class="col-md-6">
            <input type="number" class="form-control" name="serviceCategoryId" id="workerServiceCategoryId" placeholder="Service Category ID" required />
          </div>
          <div class="col-md-12">
            <textarea class="form-control" name="bio" id="workerBio" placeholder="Bio" rows="2"></textarea>
          </div>
          <div class="col-md-12">
            <input type="text" class="form-control" name="skillsJson" id="workerSkillsJson" placeholder='Skills (e.g. ["Wiring","Repair"])' />
          </div>
          <div class="col-md-6">
            <input type="number" class="form-control" name="ratePerHour" id="workerRatePerHour" placeholder="Rate Per Hour" required />
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" id="registerSubmitBtn" class="btn btn-primary">Register</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  (function() {
    // Local token retrieval (mirrors main page logic)
    function getAuthTokenLocal() {
      let token = null;
      try {
        token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
      } catch (e) {}
      if (!token) {
        const m = document.cookie.match(/(?:^|; )(?:authToken|token|jwt)=([^;]+)/);
        if (m) token = decodeURIComponent(m[1]);
      }
      if (!token && window && window.TOKEN) token = window.TOKEN;
      if (!token && window && window.app && window.app.token) token = window.app.token;
      if (!token) return null;
      token = token.replace(/^Bearer\s+/i, '').trim();
      return token || null;
    }

    // Fill the modal form with worker data
    function fillWorkerForm(worker) {
      if (!worker) return;
      $('#workerId').val(worker.id || '');
      $('#workerName').val(worker.name || '');
      $('#workerUsername').val(worker.username || '');
      $('#workerEmail').val(worker.email || '');
      $('#workerMobile').val(worker.mobile || '');
      // Do not prefill password for security
      $('#workerPassword').val('');
      $('#workerServiceCategoryId').val(worker.serviceCategoryId || worker.serviceCategory || '');
      $('#workerBio').val(worker.bio || '');
      // If skills come as array, stringify; if already string, set directly
      if (Array.isArray(worker.skills)) {
        $('#workerSkillsJson').val(JSON.stringify(worker.skills));
      } else {
        $('#workerSkillsJson').val(worker.skillsJson || worker.skills || '');
      }
      $('#workerRatePerHour').val(worker.ratePerHour || '');
      // update modal title and submit button
      $('#registerWorkerModalLabel').text(worker.id ? 'Edit Worker' : 'Register New Worker');
      $('#registerSubmitBtn').text(worker.id ? 'Save Changes' : 'Register');
    }

    // Extract worker object from various possible response shapes
    function extractWorkerFromResponse(data) {
      if (!data) return null;
      if (Array.isArray(data) && data.length) return data[0];
      if (data.content && Array.isArray(data.content) && data.content.length) return data.content[0];
      if (data.worker) return data.worker;
      // If response looks like the worker itself
      if (data.id || data.username) return data;
      return null;
    }

    // Fetch worker by id and open modal prefilled
    function openEditModal(workerId) {
      if (!workerId) return;
      const token = getAuthTokenLocal();
      const headers = {};
      if (token) headers['Authorization'] = 'Bearer ' + token;

      $.ajax({
        url: `/admin/workers?id=${encodeURIComponent(workerId)}`,
        type: 'GET',
        headers: headers,
        success: function(data) {
          const w = extractWorkerFromResponse(data);
          if (!w) {
            alert('Worker data not found.');
            return;
          }
          fillWorkerForm(w);
          // Show Bootstrap modal
          const modalEl = document.getElementById('registerWorkerModal');
          if (window.bootstrap && bootstrap.Modal) {
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();
          } else {
            // fallback to jQuery if bootstrap not available yet
            $('#registerWorkerModal').modal('show');
          }
        },
        error: function() {
          alert('Failed to fetch worker details.');
        }
      });
    }

    // Intercept clicks on .edit-btn early using capture phase to prevent existing handlers (which redirect)
    document.addEventListener('click', function(ev) {
      const btn = ev.target.closest && ev.target.closest('.edit-btn');
      if (!btn) return;
      ev.preventDefault();
      ev.stopPropagation();
      // read data-id attribute (works with elements created dynamically)
      const workerId = btn.getAttribute('data-id') || btn.dataset.id;
      openEditModal(workerId);
    }, true);

    // When modal is hidden, reset to Register mode
    document.getElementById('registerWorkerModal').addEventListener('hidden.bs.modal', function() {
      $('#registerWorkerForm')[0].reset();
      $('#workerId').val('');
      $('#registerWorkerModalLabel').text('Register New Worker');
      $('#registerSubmitBtn').text('Register');
    });
  })();
</script>
<!-- Filters (NO th:object for listing page) -->
        <div class="row mb-3 g-2">
          <div class="col-md-2">
            <select class="form-control" id="kycStatus">
              <option value="">All KYC Status</option>
              <option value="PENDING">PENDING</option>
              <option value="APPROVED">APPROVED</option>
              <option value="REJECTED">REJECTED</option>
            </select>
          </div>

          <div class="col-md-2">
            <input class="form-control" id="mobile" type="text" placeholder="Mobile number" />
          </div>

          <div class="col-md-2">
            <input class="form-control" id="name" type="text" placeholder="Name" />
          </div>

          <div class="col-md-2">
            <input class="form-control" id="fromDate" type="date" placeholder="Created From" />
          </div>

          <div class="col-md-2">
            <input class="form-control" id="toDate" type="date" placeholder="Created To" />
          </div>

          <div class="col-md-2">
            <button class="btn btn-primary w-100" id="applyFilters">Apply Filters</button>
          </div>
        </div>

        <!-- Workers Table (Data rendered by JS) -->
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="thead-light">
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Username</th>
                <th>Mobile</th>
                <th>Email</th>
                <th>KYC Status</th>
                <th>Verified</th>
                <th>Created At</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="workerRows"></tbody>
          </table>
        </div>

        <div class="d-flex align-items-center gap-2 mt-3">
          <button class="btn btn-secondary" id="prevPage" disabled>Prev</button>
          <span id="pageInfo" class="mx-2"></span>
          <button class="btn btn-secondary" id="nextPage" disabled>Next</button>
        </div>

      </div>
    </div>
    <div th:replace="fragments/footer :: footer"></div>
  </div>
</div>

<!-- Scripts -->
<script src="/admin-ui/js/core/jquery-3.7.1.min.js"></script>
<script src="/admin-ui/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
<script src="/admin-ui/js/core/popper.min.js"></script>
<script src="/admin-ui/js/core/bootstrap.min.js"></script>
<script src="/admin-ui/js/kaiadmin.min.js"></script>
<script src="/admin-ui/js/auth.js"></script>

<script>
  let page = 0;
  const size = 20;
  let totalPages = 1;
  let last = false;

  function formatDate(dateStr) {
    if (!dateStr) return '';
    const d = new Date(dateStr);
    return d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
  }

  function getFilters() {
    return {
      kycStatus: $('#kycStatus').val(),
      mobile: $('#mobile').val(),
      name: $('#name').val(),
      from: $('#fromDate').val(),
      to: $('#toDate').val()
    };
  }

  function kycStatusClass(kycStatus) {
    if (!kycStatus) return '';
    switch (kycStatus.toUpperCase()) {
      case 'PENDING': return 'status-pending';
      case 'APPROVED': return 'status-approved';
      case 'REJECTED': return 'status-rejected';
      default: return '';
    }
  }

  function buildQueryParams(filters, page) {
    const params = new URLSearchParams();
    params.append('page', page);
    params.append('size', size);
    for (const [key, value] of Object.entries(filters)) {
      if (value) {
        params.append(key, value);
      }
    }
    return params.toString();
  }

  function fetchWorkers(pageNum = 0) {
    const filters = getFilters();
    const queryParams = buildQueryParams(filters, pageNum);
    $.ajax({
      url: `/admin/workers?${queryParams}`,
      type: 'GET',
      success: function(data) {
        populateTable(data.content);
        page = data.pageable.pageNumber;
        totalPages = data.totalPages;
        last = data.last;
        updatePagination();
      },
      error: function() {
        alert('Failed to fetch workers.');
      }
    });
  }

  function populateTable(workers) {
    const tbody = $('#workerRows');
    tbody.empty();
    if (workers.length === 0) {
      tbody.append('<tr><td colspan="9" class="text-center">No workers found</td></tr>');
      return;
    }
    workers.forEach(w => {
      const statusClass = kycStatusClass(w.kycStatus);
      tbody.append(`
        <tr>
          <td>${w.id}</td>
          <td>${w.name || ''}</td>
          <td>${w.username || ''}</td>
          <td>${w.mobile || ''}</td>
          <td>${w.email || ''}</td>
          <td><span class="status-btn ${statusClass}">${w.kycStatus || ''}</span></td>
          <td>${w.verified ? 'Yes' : 'No'}</td>
          <td>${formatDate(w.createdAt)}</td>
          <td class="actions-column">
            <button class="btn btn-primary btn-sm edit-btn" data-id="${w.id}">Edit</button>
            <button class="btn btn-success btn-sm update-kyc-btn" data-id="${w.id}">Update KYC</button>
          </td>
        </tr>
      `);
    });

    $('.edit-btn').click(function() {
      const workerId = $(this).data('id');
      window.location.href = `/admin/worker/edit?id=${workerId}`;
    });

    $('.update-kyc-btn').click(function() {
      const workerId = $(this).data('id');
      window.location.href = `/worker/kyc?id=${workerId}`;
    });
  }

  function updatePagination() {
    $('#pageInfo').text(`Page ${page + 1} of ${totalPages}`);
    $('#prevPage').prop('disabled', page <= 0);
    $('#nextPage').prop('disabled', last);
  }

  function getAuthToken() {
    let token = null;
    try {
      token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
    } catch (e) {}
    if (!token) {
      const m = document.cookie.match(/(?:^|; )(?:authToken|token|jwt)=([^;]+)/);
      if (m) token = decodeURIComponent(m[1]);
    }
    if (!token && window && window.TOKEN) token = window.TOKEN;
    if (!token && window && window.app && window.app.token) token = window.app.token;
    if (!token) return null;
    token = token.replace(/^Bearer\s+/i, '').trim();
    return token || null;
  }

  $(document).ready(function() {
    fetchWorkers();

    $('#applyFilters').click(function() {
      page = 0;
      fetchWorkers();
    });

    $('#prevPage').click(function() {
      if (page > 0) {
        fetchWorkers(page - 1);
      }
    });

    $('#nextPage').click(function() {
      if (!last) {
        fetchWorkers(page + 1);
      }
    });

    $('#registerWorkerForm').submit(function(e) {
      e.preventDefault();
      const formData = Object.fromEntries(new FormData(this).entries());
      const token = getAuthToken();
      const headers = {};

      if (token) {
        if (token.split('.').length === 3) {
          headers['Authorization'] = 'Bearer ' + token;
        } else {
          console.warn('Found token but it does not look like a JWT. Skipping Authorization header.');
        }
      } else {
        console.warn('No auth token found. Sending request without Authorization header.');
      }

      $.ajax({
        url: '/admin/worker/register',
        type: 'POST',
        contentType: 'application/json',
        headers: headers,
        data: JSON.stringify(formData),
        success: function(response) {
          if (response && response.status === 'success') {
            alert('Worker registered successfully!');
            window.location.href = '/worker/listing';
          } else {
            alert((response && response.message) || 'Registration failed.');
          }
        },
        error: function(xhr) {
          let err = 'Something went wrong.';
          try {
            const json = xhr.responseJSON || JSON.parse(xhr.responseText || '{}');
            err = json.message || err;
          } catch (e) {}
          alert(err);
        }
      });
    });
  });
</script>



</body>
</html>
