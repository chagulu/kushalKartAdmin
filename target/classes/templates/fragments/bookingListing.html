<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Booking Listing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; background:#0f172a; color:#e2e8f0; }
    header { padding:16px 20px; background:#111827; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; }
    .container { padding:20px; }
    .pill { background:#1f2937; border:1px solid #334155; padding:6px 10px; border-radius:999px; font-size:12px; color:#93c5fd; }
    button { padding:8px 12px; border-radius:8px; border:none; background:#2563eb; color:white; font-weight:600; cursor:pointer; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { border-bottom:1px solid #1f2937; padding:10px; font-size:14px; text-align:left; }
    th { color:#93c5fd; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:12px 0; }
    select, input { padding:8px 10px; border-radius:8px; border:1px solid #334155; background:#0b1220; color:#e2e8f0; }
    .pager { margin-top:12px; display:flex; gap:8px; align-items:center; }
  </style>
</head>
<body>
  <!-- Injected Header -->
  <div id="header"></div>

  <div class="container">
    <div class="row">
      <select id="status">
        <option value="">All Status</option>
        <option>PENDING</option>
        <option>CONFIRMED</option>
        <option>COMPLETED</option>
        <option>CANCELLED</option>
      </select>

      <select id="paymentStatus">
        <option value="">All Payments</option>
        <option>PENDING</option>
        <option>PAID</option>
        <option>FAILED</option>
      </select>

      <input id="consumerId" type="number" placeholder="Consumer ID" />
      <input id="workerId" type="number" placeholder="Worker ID" />
      <button id="applyFilters">Apply</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>ID</th><th>Consumer</th><th>Worker</th><th>Status</th><th>Payment</th><th>Amount</th><th>Scheduled</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <div class="pager">
      <button id="prev">Prev</button>
      <span id="pageInfo"></span>
      <button id="next">Next</button>
    </div>
  </div>

  <!-- Auth utilities -->
  <script src="/admin-ui/js/auth.js"></script>

  <!-- Inject header fragment -->
  <script>
    async function loadFragment(id, url) {
      const res = await fetch(url);
      const html = await res.text();
      document.getElementById(id).innerHTML = html;

      // After header loads, bind logout and user info
      const token = requireAuth();
      if (!token) return;

      const who = document.getElementById('who');
      const user = getUser();
      if (user && who) {
        who.textContent = `${user.username} • ${user.role}`;
      }

      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', () => logout());
      }
    }

    loadFragment('header', '/admin-ui/header.html');
  </script>

  <!-- Booking Listing Logic -->
  <script>
    const rows = document.getElementById('rows');
    const pageInfo = document.getElementById('pageInfo');
    const statusEl = document.getElementById('status');
    const paymentStatusEl = document.getElementById('paymentStatus');
    const consumerIdEl = document.getElementById('consumerId');
    const workerIdEl = document.getElementById('workerId');

    let page = 0, size = 10, last = false;

    async function fetchBookings() {
      const params = new URLSearchParams();
      params.set('page', page);
      params.set('size', size);
      if (statusEl.value) params.set('status', statusEl.value);
      if (paymentStatusEl.value) params.set('paymentStatus', paymentStatusEl.value);
      if (consumerIdEl.value) params.set('consumerId', consumerIdEl.value);
      if (workerIdEl.value) params.set('workerId', workerIdEl.value);

      const res = await authFetch(`/admin/bookings?${params.toString()}`, {
        method: 'GET'
      });
      if (!res) return;

      const data = await res.json();
      const pageData = data.data || data;

      rows.innerHTML = '';
      (pageData.content || []).forEach(b => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${b.id}</td>
          <td>${b.consumerId}</td>
          <td>${b.workerId}</td>
          <td>${b.status}</td>
          <td>${b.paymentStatus}</td>
          <td>${b.amount ?? ''}</td>
          <td>${b.scheduledTime ?? ''}</td>
        `;
        rows.appendChild(tr);
      });

      const current = (pageData.number ?? page) + 1;
      const totalPages = pageData.totalPages ?? current;
      const totalElements = pageData.totalElements ?? (pageData.content?.length || 0);
      pageInfo.textContent = `Page ${current} of ${totalPages} • ${totalElements} results`;

      last = pageData.last ?? (current >= totalPages);
    }

    document.getElementById('applyFilters').addEventListener('click', () => {
      page = 0; fetchBookings();
    });
    document.getElementById('prev').addEventListener('click', () => {
      if (page > 0) { page--; fetchBookings(); }
    });
    document.getElementById('next').addEventListener('click', () => {
      if (!last) { page++; fetchBookings(); }
    });

    fetchBookings();
  </script>
</body>
</html>
