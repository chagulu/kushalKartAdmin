<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Booking Listing</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Kaiadmin CSS -->
    <link rel="stylesheet" href="/admin-ui/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="/admin-ui/css/kaiadmin.min.css"/>
</head>
<body>
<div class="wrapper">

    <!-- Sidebar -->
    <div th:replace="fragments/sidebar :: sidebar"></div>

    <!-- Main Panel -->
    <div class="main-panel">

        <!-- Navbar -->
        <div th:replace="fragments/navbar :: navbar"></div>

        <!-- Page Content -->
        <div class="container-fluid">
            <h4 class="page-title">Booking Listing</h4>

            <!-- Filters -->
            <div class="row mb-3">
                <div class="col-md-2">
                    <select class="form-control" id="status">
                        <option value="">All Status</option>
                        <option>PENDING</option>
                        <option>CONFIRMED</option>
                        <option>COMPLETED</option>
                        <option>CANCELLED</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <select class="form-control" id="paymentStatus">
                        <option value="">All Payments</option>
                        <option>PENDING</option>
                        <option>PAID</option>
                        <option>FAILED</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <input class="form-control" id="consumerId" type="number" placeholder="Consumer ID" />
                </div>

                <div class="col-md-2">
                    <input class="form-control" id="workerId" type="number" placeholder="Worker ID" />
                </div>

                <div class="col-md-2">
                    <button class="btn btn-primary w-100" id="applyFilters">Apply</button>
                </div>
            </div>

            <!-- Table -->
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="thead-light">
                    <tr>
                        <th>ID</th>
                        <th>Consumer</th>
                        <th>Worker</th>
                        <th>Status</th>
                        <th>Payment</th>
                        <th>Amount</th>
                        <th>Scheduled</th>
                    </tr>
                    </thead>
                    <tbody id="rows"></tbody>
                </table>
            </div>

            <!-- Pager -->
            <div class="d-flex align-items-center gap-2 mt-3">
                <button class="btn btn-secondary" id="prev">Prev</button>
                <span id="pageInfo" class="mx-2"></span>
                <button class="btn btn-secondary" id="next">Next</button>
            </div>
        </div>

        <!-- Footer -->
        <div th:replace="fragments/footer :: footer"></div>
    </div>
</div>

<!-- Scripts -->
<script src="/admin-ui/js/core/jquery-3.7.1.min.js"></script>
<script src="/admin-ui/js/core/popper.min.js"></script>
<script src="/admin-ui/js/core/bootstrap.min.js"></script>
<script src="/admin-ui/js/kaiadmin.min.js"></script>
<script src="/admin-ui/js/auth.js"></script>

<script>
    const rows = document.getElementById('rows');
    const pageInfo = document.getElementById('pageInfo');
    const statusEl = document.getElementById('status');
    const paymentStatusEl = document.getElementById('paymentStatus');
    const consumerIdEl = document.getElementById('consumerId');
    const workerIdEl = document.getElementById('workerId');

    let page = 0, size = 10, last = false;

    async function fetchBookings() {
        const params = new URLSearchParams();
        params.set('page', page);
        params.set('size', size);
        if (statusEl.value) params.set('status', statusEl.value);
        if (paymentStatusEl.value) params.set('paymentStatus', paymentStatusEl.value);
        if (consumerIdEl.value) params.set('consumerId', consumerIdEl.value);
        if (workerIdEl.value) params.set('workerId', workerIdEl.value);

        const res = await authFetch(`/admin/bookings?${params.toString()}`, { method: 'GET' });
        if (!res) return;

        const data = await res.json();
        const pageData = data.data || data;

        rows.innerHTML = '';
        (pageData.content || []).forEach(b => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${b.id}</td>
                <td>${b.consumerId}</td>
                <td>${b.workerId}</td>
                <td>${b.status}</td>
                <td>${b.paymentStatus}</td>
                <td>${b.amount ?? ''}</td>
                <td>${b.scheduledTime ?? ''}</td>
            `;
            rows.appendChild(tr);
        });

        const current = (pageData.number ?? page) + 1;
        const totalPages = pageData.totalPages ?? current;
        const totalElements = pageData.totalElements ?? (pageData.content?.length || 0);
        pageInfo.textContent = `Page ${current} of ${totalPages} â€¢ ${totalElements} results`;

        last = pageData.last ?? (current >= totalPages);
    }

    document.getElementById('applyFilters').addEventListener('click', () => {
        page = 0; fetchBookings();
    });
    document.getElementById('prev').addEventListener('click', () => {
        if (page > 0) { page--; fetchBookings(); }
    });
    document.getElementById('next').addEventListener('click', () => {
        if (!last) { page++; fetchBookings(); }
    });

    // On page load
    fetchBookings();
</script>
</body>
</html>
