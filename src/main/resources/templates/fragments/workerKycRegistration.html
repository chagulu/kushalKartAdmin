<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>KushalKart Admin - Worker KYC Registration</title>
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport" />
  <link rel="icon" href="/admin-ui/img/kaiadmin/favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="/admin-ui/css/bootstrap.min.css" />
  <link rel="stylesheet" href="/admin-ui/css/plugins.min.css" />
  <link rel="stylesheet" href="/admin-ui/css/kaiadmin.min.css" />
  <link rel="stylesheet" href="/admin-ui/css/demo.css" />
  <style>
    label { font-weight: 500; }
    .image-preview { max-width: 160px; max-height: 160px; border: 1px solid #ccc; margin-bottom: 6px; }
  </style>
</head>
<body>
<div class="wrapper">
  <div th:replace="fragments/sidebar :: sidebar"></div>
  <div class="main-panel">
    <div class="container">
      <div class="page-inner">
        <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4">
          <div>
            <h3 class="fw-bold mb-3">Worker KYC Registration</h3>
            <h6 class="op-7 mb-2">View and update KYC information</h6>
          </div>
        </div>

        <form id="kycForm" enctype="multipart/form-data" class="needs-validation" novalidate>
          <input type="hidden" id="workerId" name="workerId" />
          <input type="hidden" id="adminId" name="adminId" value="1" />
          <div class="row g-3">
            <div class="col-md-6">
              <label for="aadhaarNumber" class="form-label">Aadhaar Number</label>
              <input type="text" id="aadhaarNumber" name="aadhaarNumber" class="form-control" maxlength="20" required />
              <div class="invalid-feedback">Please enter Aadhaar Number.</div>
            </div>

            <div class="col-md-6">
              <label class="form-label">Aadhaar Front (required)</label>
              <div id="aadhaarFrontPreview"></div>
              <input type="file" id="aadhaarFront" name="aadhaarFront" accept="image/*" class="form-control" required />
              <div class="invalid-feedback">Please select Aadhaar Front image.</div>
            </div>

            <div class="col-md-6">
              <label class="form-label">Aadhaar Back (required)</label>
              <div id="aadhaarBackPreview"></div>
              <input type="file" id="aadhaarBack" name="aadhaarBack" accept="image/*" class="form-control" required />
              <div class="invalid-feedback">Please select Aadhaar Back image.</div>
            </div>

            <div class="col-md-6">
              <label class="form-label">Worker Photo (required)</label>
              <div id="workerPhotoPreview"></div>
              <input type="file" id="workerPhoto" name="workerPhoto" accept="image/*" class="form-control" required />
              <div class="invalid-feedback">Please select Worker Photo image.</div>
            </div>

            <div class="col-12 mt-3">
              <button class="btn btn-success" type="submit">Save KYC Info</button>
              <a href="/admin/workers" class="btn btn-secondary ms-2">Back to List</a>
            </div>
          </div>
        </form>

      </div>
    </div>
  </div>
</div>

<script src="/admin-ui/js/auth.js"></script>
<script src="/admin-ui/js/core/jquery-3.7.1.min.js"></script>
<script src="/admin-ui/js/core/bootstrap.min.js"></script>
<script>
  $(document).ready(function() {
    const params = new URLSearchParams(window.location.search);
    const workerId = params.get('id');
    $('#workerId').val(workerId);

    if(workerId) {
      authFetch(`/admin/workers?id=${workerId}`)
        .then(resp => resp.json())
        .then(data => {
          const worker = Array.isArray(data.content) ? data.content[0] : data;
          if(worker) {
            $('#aadhaarNumber').val(worker.aadhaarNumber || '');
            // Show existing uploaded images as previews
            if(worker.aadhaarFront) {
              $('#aadhaarFrontPreview').html(`<img src="${worker.aadhaarFront}" class="image-preview" alt="Aadhaar Front" />`);
            }
            if(worker.aadhaarBack) {
              $('#aadhaarBackPreview').html(`<img src="${worker.aadhaarBack}" class="image-preview" alt="Aadhaar Back" />`);
            }
            if(worker.workerPhoto) {
              $('#workerPhotoPreview').html(`<img src="${worker.workerPhoto}" class="image-preview" alt="Worker Photo" />`);
            }
          }
        })
        .catch(() => {
          alert('Failed to load worker KYC info. Please login again.');
          window.location.href = '/login.html';
        });
    }

    $('#kycForm').submit(function(event) {
      event.preventDefault();

      if (!this.checkValidity()) {
        event.stopPropagation();
        $(this).addClass('was-validated');
        return;
      }

      const token = getToken();
      if (!token) {
        alert('Admin token missing, please login');
        window.location.href = '/login.html';
        return;
      }

      const formData = new FormData();
      formData.append('aadhaarNumber', $('#aadhaarNumber').val());
      formData.append('aadhaarFront', $('#aadhaarFront')[0].files);
      formData.append('aadhaarBack', $('#aadhaarBack').files);
      formData.append('workerPhoto', $('#workerPhoto').files);
      formData.append('adminId', $('#adminId').val());

      $.ajax({
        url: `/admin/worker/kyc/${workerId}`,
        type: 'POST',
        headers: {
          'Authorization': 'Bearer ' + token
        },
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
          alert('KYC updated successfully');
          // Redirect back to same form so it reloads with updated data
          window.location.href = `/worker/kyc?id=${workerId}`;
        },
        error: function(xhr) {
          alert('Failed to update KYC: ' + xhr.responseText);
        }
      });
    });
  });
</script>
</body>
</html>
