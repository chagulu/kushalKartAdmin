<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>KushalKart Admin - Worker KYC Registration</title>
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport" />
  <link rel="icon" href="/admin-ui/img/kaiadmin/favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="/admin-ui/css/bootstrap.min.css" />
  <link rel="stylesheet" href="/admin-ui/css/plugins.min.css" />
  <link rel="stylesheet" href="/admin-ui/css/kaiadmin.min.css" />
  <link rel="stylesheet" href="/admin-ui/css/demo.css" />
  <style>
    label { font-weight: 500; }
    .image-preview { max-width: 160px; max-height: 160px; border: 1px solid #ccc; margin-bottom: 6px; }
  </style>
</head>
<body>
<div class="wrapper">
  <div th:replace="fragments/sidebar :: sidebar"></div>
  <div class="main-panel">
    <div class="container">
      <div class="page-inner">
        <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4">
          <div>
            <h3 class="fw-bold mb-3">Worker KYC Registration</h3>
            <h6 class="op-7 mb-2">View and update KYC information</h6>
          </div>
        </div>

        <!-- Approve/Reject Section -->
        <div class="mb-4">
          <label for="kycAction" class="form-label">KYC Action</label>
          <select id="kycAction" class="form-select w-auto d-inline-block">
            <option value="">-- Select Action --</option>
             <option value="pending">Pending</option>
            <option value="reject">Reject</option>
            <option value="approve">Approve</option>
          </select>
          <button id="submitKycAction" type="button" class="btn btn-primary ms-2">Submit Action</button>
        </div>

        <!-- Main KYC Form -->
        <form id="kycForm" enctype="multipart/form-data" class="needs-validation" novalidate>
          <input type="hidden" id="workerId" name="workerId" />
          <input type="hidden" id="adminId" name="adminId" value="1" />

          <div class="row g-3">
            <!-- Read-only fields -->
            <div class="col-md-6">
              <label class="form-label">Name</label>
              <input type="text" id="name" class="form-control" readonly />
            </div>

            <div class="col-md-6">
              <label class="form-label">Mobile</label>
              <input type="text" id="mobile" class="form-control" readonly />
            </div>

            <div class="col-md-6">
              <label class="form-label">Aadhaar (masked)</label>
              <input type="text" id="aadhaarNumberMasked" class="form-control" readonly />
            </div>

            <!-- Editable Aadhaar Number -->
            <div class="col-md-6">
              <label for="aadhaarNumber" class="form-label">Aadhaar Number</label>
              <input type="text" id="aadhaarNumber" name="aadhaarNumber" class="form-control" maxlength="20" required />
              <div class="invalid-feedback">Please enter Aadhaar Number.</div>
            </div>

            <div class="col-md-6">
              <label class="form-label">Aadhaar Front (required)</label>
              <div id="aadhaarFrontPreview"></div>
              <input type="file" id="aadhaarFront" name="aadhaarFront" accept="image/*" class="form-control" required />
              <div class="invalid-feedback">Please select Aadhaar Front image.</div>
            </div>

            <div class="col-md-6">
              <label class="form-label">Aadhaar Back (required)</label>
              <div id="aadhaarBackPreview"></div>
              <input type="file" id="aadhaarBack" name="aadhaarBack" accept="image/*" class="form-control" required />
              <div class="invalid-feedback">Please select Aadhaar Back image.</div>
            </div>

            <div class="col-md-6">
          <label for="workerPhoto" class="form-label">Worker Photo <span class="text-danger">(required)</span></label>
          <div id="workerPhotoPreview" class="mb-2"></div>
          <input type="file" id="workerPhoto" name="workerPhoto" accept="image/*" class="form-control" required />
          <div class="invalid-feedback">Please select Worker Photo image.</div>
        </div>

        <div class="col-md-6">
          <label class="form-label">KYC Status</label>
          <div class="mb-3">
            <span id="kycStatusText" class="fw-bold text-primary"></span>
          </div>
        </div>


            <div class="col-12 mt-3">
              <button class="btn btn-success" type="submit">Save KYC Info</button>
              <a href="/worker/listing" class="btn btn-secondary ms-2">Back to List</a>
            </div>
          </div>
        </form>

      </div>
    </div>
  </div>
</div>

<script src="/admin-ui/js/auth.js"></script>
<script src="/admin-ui/js/core/jquery-3.7.1.min.js"></script>
<script src="/admin-ui/js/core/bootstrap.min.js"></script>
<script src="/admin-ui/js/auth.js"></script>
<script src="/admin-ui/js/core/jquery-3.7.1.min.js"></script>
<script src="/admin-ui/js/core/bootstrap.min.js"></script>
<script>
  $(document).ready(function () {
    const params = new URLSearchParams(window.location.search);
    const workerId = params.get('id');
    $('#workerId').val(workerId);

    // --- Helpers ---
    function isPublicUrl(url) {
    return typeof url === 'string' && (
      url.startsWith('/uploads/') ||
      url.startsWith('/files/') ||
      url.startsWith('/tmp/') ||
      url.startsWith('https://') ||
      url.startsWith('http://')
    );
  }


    function getStatusColor(status) {
      switch ((status || '').toUpperCase()) {
        case 'APPROVED':
        case 'VERIFIED': return 'success';
        case 'REJECTED': return 'danger';
        case 'PENDING':
        default: return 'primary';
      }
    }

    // --- Core data loader (can be reused after upload) ---
    function loadWorkerData() {
      if (!workerId) return;

      authFetch(`/admin/workers?id=${workerId}&page=0&size=1`)
        .then(resp => resp.json())
        .then(data => {
          const worker = Array.isArray(data.content) ? data.content[0] : data;
          if (!worker) return;

          // Basic fields
          $('#name').val(worker.name || '');
          $('#mobile').val(worker.mobile || '');
          const maskedAadhaar = worker.kyc?.aadhaarNumber || '';
          $('#aadhaarNumberMasked').val(maskedAadhaar);
          $('#aadhaarNumber').val(maskedAadhaar);

          // Aadhaar Front
          if (isPublicUrl(worker.aadhaarFront)) {
            $('#aadhaarFrontPreview').html(
              `<img src="${worker.aadhaarFront}?t=${Date.now()}" class="image-preview" alt="Aadhaar Front" />`
            );
          }

          // Aadhaar Back
          if (isPublicUrl(worker.aadhaarBack)) {
            $('#aadhaarBackPreview').html(
              `<img src="${worker.aadhaarBack}?t=${Date.now()}" class="image-preview" alt="Aadhaar Back" />`
            );
          }

          // Worker Photo
          if (isPublicUrl(worker.workerPhoto)) {
            $('#workerPhotoPreview').html(
              `<img src="${worker.workerPhoto}?t=${Date.now()}" class="image-preview" alt="Worker Photo" />`
            );
          }

          // KYC Status (prefer nested)
          const status = worker.kyc?.status || worker.kycStatus || 'N/A';
          $('#kycStatusText')
            .text(status)
            .removeClass()
            .addClass(`fw-bold text-${getStatusColor(status)}`);
        })
        .catch(() => {
          alert('Failed to load worker KYC info. Please login again.');
          window.location.href = '/admin/login';
        });
    }

    // Initial load
    loadWorkerData();

    // --- Submit KYC form ---
    $('#kycForm').submit(function (event) {
      event.preventDefault();

      if (!this.checkValidity()) {
        event.stopPropagation();
        $(this).addClass('was-validated');
        return;
      }

      const token = getToken();
      if (!token) {
        alert('Admin token missing, please login');
        window.location.href = '/admin/login';
        return;
      }

      const formData = new FormData();
      formData.append('aadhaarNumber', $('#aadhaarNumber').val());
      formData.append('aadhaarFront', $('#aadhaarFront')[0].files[0]);
      formData.append('aadhaarBack', $('#aadhaarBack')[0].files[0]);
      formData.append('workerPhoto', $('#workerPhoto')[0].files[0]);
      formData.append('adminId', $('#adminId').val());

      $.ajax({
        url: `/admin/worker/kyc/${$('#workerId').val()}`,
        type: 'POST',
        headers: { 'Authorization': 'Bearer ' + token },
        data: formData,
        processData: false,
        contentType: false,
        success: function () {
          alert('KYC updated successfully');
          loadWorkerData(); // refresh previews & status right away
        },
        error: function (xhr) {
          alert('Failed to update KYC: ' + xhr.responseText);
        }
      });
    });

    // --- Approve/Reject handler ---
    $('#submitKycAction').on('click', function () {
      const action = $('#kycAction').val();
      const token = getToken();

      if (!action) {
        alert('Please select an action');
        return;
      }
      if (!token) {
        alert('Admin token missing, please login');
        window.location.href = '/admin/login';
        return;
      }

      $.ajax({
        url: `/admin/worker/kyc/${$('#workerId').val()}/${action}`,
        type: 'POST',
        headers: { 'Authorization': 'Bearer ' + token },
        success: function () {
          alert(`KYC ${action}d successfully`);
          loadWorkerData(); // reload to reflect latest status & photos
        },
        error: function (xhr) {
          alert(`Failed to ${action} KYC: ` + xhr.responseText);
        }
      });
    });
  });
</script>



</body>
</html>